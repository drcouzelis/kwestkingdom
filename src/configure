#!/bin/bash

echo Generating `pwd`/Makefile

rm -f Makefile

echo 'CC = gcc' >> Makefile
echo 'OUTPUT = ../Linux/share/kwestkingdom/kwestkingdom' >> Makefile
echo 'DEBUG = -Wall' >> Makefile
echo 'LINKING_OPTIONS = -l objc' >> Makefile
echo 'CFLAGS = $(shell allegro-config --cflags)' >> Makefile
echo 'LDFLAGS = $(shell allegro-config --libs)' >> Makefile
echo >> Makefile

echo 'WIN_CC = wine c:\\MinGW\\bin\\gcc.exe' >> Makefile
echo 'WIN_OUTPUT = ../Windows/kwestkingdom' >> Makefile
echo >> Makefile

echo HEADERS = `ls *.h` >> Makefile
echo >> Makefile

echo OBJECTS = $(ls *.m | sed -e 's/\.m/.o/') >> Makefile
echo >> Makefile


echo 'kk_main: $(OBJECTS)' >> Makefile
echo $'\t mkdir -p ../Linux/share/kwestkingdom' >> Makefile
echo $'\t $(CC) $(DEBUG) $(LINKING_OPTIONS) -o $(OUTPUT) $(OBJECTS) $(LDFLAGS)' >> Makefile
echo >> Makefile


for i in *.m; do
  echo $(ls "$i" | sed -e 's/\.m/.o/')': '"$i" '$(HEADERS)' >> Makefile
  echo $'\t $(CC) $(DEBUG) -c' "$i" '$(CFLAGS)' >> Makefile
  echo >> Makefile
done;


echo 'clean:' >> Makefile
echo $'\t rm -f $(OBJECTS)' >> Makefile
echo >> Makefile


# Redo the Windows section
echo 'win:' >> Makefile
#echo $'\t $(WIN_CC) $(DEBUG) *.m -o $(WIN_OUTPUT) -lobjc -lalleg' >> Makefile
echo $'\t mkdir -p ../Windows' >> Makefile
echo $'\t echo Pretending to build the Windows version...' >> Makefile
echo >> Makefile

